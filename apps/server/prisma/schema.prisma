generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // set to "postgresql" for central server or "sqlite" for local testing
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  name        String
  email       String?  @unique
  role        Role
  passwordHash String
  passwordHint String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  devices     Device[]
  methods     Method[] @relation("MethodCreator")
  experiments Experiment[]
  revisions   ExperimentRevision[]
  signatures  Signature[]
  comments    Comment[]
  notifications Notification[]
  apiKeys     APIKey[]
  webhooks    Webhook[]
}

model Device {
  id         String   @id @default(uuid())
  name       String?
  lastSeenAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  userId     String

  syncState  SyncState?
  changeLogs ChangeLog[]
}

model Method {
  id             String   @id @default(uuid())
  title          String
  category       String?
  steps          Json
  reagents       Json?
  attachments    Json?
  createdBy      String?
  creator        User?    @relation("MethodCreator", fields: [createdBy], references: [id])
  version        Int      @default(1)
  updatedAt      DateTime @updatedAt
  isPublic       Boolean  @default(true)
  parentMethodId String?  // For versioning - links to the original method
  parentMethod   Method?  @relation("MethodVersions", fields: [parentMethodId], references: [id])
  childVersions  Method[] @relation("MethodVersions")

  experiments    Experiment[] @relation("ExperimentProtocol")
  attachmentsRef Attachment[]
  signatures     Signature[]
  comments       Comment[]
}

model Experiment {
  id                  String   @id @default(uuid())
  title               String
  project             String?
  modality            Modality
  customModality      String?  // For 'other' modality - stores user-defined experiment type
  protocolRef         String?
  protocol            Method?  @relation("ExperimentProtocol", fields: [protocolRef], references: [id])
  params              Json?
  observations        Json?
  troubleshootingNotes String? // Separate field for troubleshooting documentation
  resultsSummary      String?
  dataLink            String?
  tags                String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  version        Int      @default(1)
  status         String   @default("draft") // draft, in_progress, completed, signed

  user   User   @relation(fields: [userId], references: [id])
  userId String

  revisions      ExperimentRevision[]
  attachments    Attachment[]
  reports        Report[]
  signatures     Signature[]
  comments       Comment[]
  stockUsages    ExperimentStock[]
  poolUsages     PoolUsage[]
  quickEntries   QuickEntry[]
}

model ExperimentRevision {
  id           Int      @id @default(autoincrement())
  experiment   Experiment @relation(fields: [experimentId], references: [id])
  experimentId String
  version      Int
  author       User?    @relation(fields: [authorId], references: [id])
  authorId     String?
  notes        String?
  snapshot     String?  // JSON snapshot of the experiment state at this version
  createdAt    DateTime @default(now())
}

model Attachment {
  id           String   @id @default(uuid())
  filename     String
  mime         String?
  size         Int?
  blobPath     String?
  dataLink     String?
  createdAt    DateTime @default(now())

  experiment   Experiment? @relation(fields: [experimentId], references: [id])
  experimentId String?

  method       Method? @relation(fields: [methodId], references: [id])
  methodId     String?
}

// Report attachments from external analytical programs (FRAP, SPT, etc.)
model Report {
  id               String   @id @default(uuid())
  reportType       String   // FRAP, SPT, flow_cytometry, image_analysis, sequencing, mass_spec, custom
  filename         String
  originalFilename String?
  mime             String?
  size             Int?
  blobPath         String?
  notes            String?
  metadata         Json?    // Tool-specific metadata (e.g., analysis parameters, software version)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  experiment       Experiment @relation(fields: [experimentId], references: [id])
  experimentId     String

  @@index([experimentId])
  @@index([reportType])
}

model SyncState {
  deviceId      String  @id
  device        Device  @relation(fields: [deviceId], references: [id])
  lastPulledAt  DateTime?
  lastPushedAt  DateTime?
  status        String?
  error         String?
}

model ChangeLog {
  id         String   @id @default(uuid())
  device     Device?  @relation(fields: [deviceId], references: [id])
  deviceId   String?
  entityType String
  entityId   String
  operation  String
  version    Int?
  oldValue   String?  // JSON snapshot of old values
  newValue   String?  // JSON snapshot of new values
  fieldName  String?  // Specific field that was changed
  createdAt  DateTime @default(now())
}

// ==================== INVENTORY MANAGEMENT ====================

model Location {
  id          String   @id @default(uuid())
  name        String
  description String?
  parentId    String?  // For hierarchical locations (building > room > freezer > shelf)
  parent      Location?  @relation("LocationHierarchy", fields: [parentId], references: [id])
  children    Location[] @relation("LocationHierarchy")
  temperature String?  // e.g., "room_temp", "-20C", "-80C", "4C"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stocks      Stock[]
}

model InventoryItem {
  id             String   @id @default(uuid())
  name           String
  description    String?
  category       String   // reagent, plasmid, antibody, primer, cell_line, sample, consumable
  catalogNumber  String?
  manufacturer   String?
  supplier       String?
  unit           String?  // e.g., "ml", "mg", "units", "vials"
  properties     String?  // JSON for custom properties (concentration, MW, etc.)
  safetyInfo     String?  // Hazard information, handling instructions
  storageConditions String? // Storage requirements
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  stocks         Stock[]
}

model Stock {
  id              String   @id @default(uuid())
  item            InventoryItem @relation(fields: [itemId], references: [id])
  itemId          String
  location        Location? @relation(fields: [locationId], references: [id])
  locationId      String?
  lotNumber       String?
  quantity        Float
  initialQuantity Float
  expirationDate  DateTime?
  receivedDate    DateTime @default(now())
  barcode         String?  @unique
  status          String   @default("available") // available, low, empty, expired, disposed
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  experimentUsages  ExperimentStock[]
  poolContributions PoolContribution[]
}

model ExperimentStock {
  id           String   @id @default(uuid())
  experiment   Experiment @relation(fields: [experimentId], references: [id])
  experimentId String
  stock        Stock @relation(fields: [stockId], references: [id])
  stockId      String
  quantityUsed Float
  usedAt       DateTime @default(now())
  notes        String?
}

// ==================== COMPLIANCE & SIGNATURES ====================

model Signature {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  signatureType String  // author, witness, reviewer, approver
  meaning      String?  // e.g., "I certify this data is accurate"
  timestamp    DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  
  // Polymorphic relation - only one should be set
  experiment   Experiment? @relation(fields: [experimentId], references: [id])
  experimentId String?
  method       Method? @relation(fields: [methodId], references: [id])
  methodId     String?
  
  // Hash of the signed content for integrity verification
  contentHash  String
}

// ==================== COLLABORATION ====================

model Comment {
  id           String   @id @default(uuid())
  content      String
  author       User     @relation(fields: [authorId], references: [id])
  authorId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Polymorphic relation - only one should be set
  experiment   Experiment? @relation(fields: [experimentId], references: [id])
  experimentId String?
  method       Method? @relation(fields: [methodId], references: [id])
  methodId     String?
  
  // For threaded comments
  parentId     String?
  parent       Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies      Comment[] @relation("CommentThread")
}

model Notification {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  type         String   // comment, mention, assignment, signature_request, stock_low
  title        String
  message      String
  entityType   String?  // experiment, method, stock
  entityId     String?
  read         Boolean  @default(false)
  createdAt    DateTime @default(now())
}

// ==================== API KEY MANAGEMENT ====================

model APIKey {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  name         String
  keyHash      String   @unique
  keyPrefix    String   // First 8-12 chars for identification
  permissions  String   // JSON array of permissions
  expiresAt    DateTime?
  lastUsedAt   DateTime?
  createdAt    DateTime @default(now())
  revokedAt    DateTime?
}

// ==================== WEBHOOKS ====================

model Webhook {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  name         String
  url          String
  secret       String?  // For signature verification
  events       String   // JSON array of event types
  active       Boolean  @default(true)
  lastTriggeredAt DateTime?
  failureCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==================== AUTOMATION WORKFLOWS ====================

model Workflow {
  id          String   @id @default(uuid())
  name        String
  description String?
  trigger     String   // JSON: type, conditions, entityType, etc.
  steps       String   // JSON array of workflow steps
  enabled     Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  executions  WorkflowExecution[]
}

model WorkflowExecution {
  id           String   @id @default(uuid())
  workflow     Workflow @relation(fields: [workflowId], references: [id])
  workflowId   String
  triggeredBy  String?  // Entity that triggered the workflow
  triggerData  String?  // JSON: Data from the trigger event
  status       String   @default("pending") // pending, running, completed, failed
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  error        String?
  stepResults  String?  // JSON array of step execution results
}

// ==================== LABELS & BARCODES ====================

model LabelTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  entityType  String   // inventory, stock, sample, equipment, experiment
  format      String   // qrcode, barcode128, datamatrix, etc.
  width       Float    // in mm
  height      Float    // in mm
  content     String   // JSON: template layout and fields
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  labels      Label[]
}

model Label {
  id           String   @id @default(uuid())
  template     LabelTemplate @relation(fields: [templateId], references: [id])
  templateId   String
  entityType   String   // What this label is attached to
  entityId     String   // ID of the entity
  barcodeData  String   // The encoded data
  printedAt    DateTime?
  printedBy    String?
  createdAt    DateTime @default(now())
  
  scanEvents   ScanEvent[]
}

model ScanEvent {
  id         String   @id @default(uuid())
  label      Label    @relation(fields: [labelId], references: [id])
  labelId    String
  scannedBy  String   // User ID
  scannedAt  DateTime @default(now())
  action     String?  // Action taken after scan (e.g., "consume", "link_experiment")
  context    String?  // JSON: Additional context like experiment ID, quantity used
}

// ==================== DASHBOARDS & ANALYTICS ====================

model Dashboard {
  id          String   @id @default(uuid())
  name        String
  description String?
  layout      String   // JSON: Grid layout configuration
  isPublic    Boolean  @default(false)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  widgets     DashboardWidget[]
}

model DashboardWidget {
  id           String   @id @default(uuid())
  dashboard    Dashboard @relation(fields: [dashboardId], references: [id])
  dashboardId  String
  name         String
  type         String   // chart_bar, chart_line, chart_pie, chart_scatter, table, metric, sql
  config       String   // JSON: chart options, colors, etc.
  query        String?  // SQL query or predefined query ID
  position     String   // JSON: {x, y, w, h} for grid position
  refreshRate  Int?     // Refresh interval in seconds
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SavedQuery {
  id          String   @id @default(uuid())
  name        String
  description String?
  query       String   // SQL query
  parameters  String?  // JSON array of parameter definitions
  createdBy   String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== SAMPLE POOLING ====================

model SamplePool {
  id           String   @id @default(uuid())
  name         String
  description  String?
  purpose      String?  // e.g., "buffer_formulation", "high_throughput_assay", "dilution_series"
  totalVolume  Float?   // Total volume after pooling
  unit         String?  // Volume unit (ml, ul, etc.)
  status       String   @default("active") // active, consumed, disposed
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  contributions PoolContribution[]
  usages        PoolUsage[]
}

model PoolContribution {
  id             String   @id @default(uuid())
  pool           SamplePool @relation(fields: [poolId], references: [id])
  poolId         String
  stock          Stock    @relation(fields: [stockId], references: [id])
  stockId        String
  volumeAdded    Float    // Amount contributed from this stock
  unit           String   // Volume unit
  concentration  Float?   // Concentration at time of contribution
  addedAt        DateTime @default(now())
  addedBy        String
  notes          String?
}

model PoolUsage {
  id             String   @id @default(uuid())
  pool           SamplePool @relation(fields: [poolId], references: [id])
  poolId         String
  volumeUsed     Float
  unit           String
  purpose        String?
  experiment     Experiment? @relation(fields: [experimentId], references: [id])
  experimentId   String?
  usedAt         DateTime @default(now())
  usedBy         String
  notes          String?
}

// ==================== MOBILE COMPANION MODELS ====================

model MobileDevice {
  id           String   @id @default(uuid())
  deviceId     String   @unique // Hardware/app device identifier
  name         String?
  platform     String   // ios, android, etc.
  userId       String
  pushToken    String?  // For push notifications
  lastSyncAt   DateTime?
  lastActiveAt DateTime @default(now())
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  
  quickEntries QuickEntry[]
  bookings     EquipmentBooking[]
}

model QuickEntry {
  id           String   @id @default(uuid())
  deviceId     String
  device       MobileDevice @relation(fields: [deviceId], references: [id])
  type         String   // measurement, note, observation, photo
  content      String   // JSON content
  location     String?  // JSON with lat/lng
  experimentId String?
  experiment   Experiment? @relation(fields: [experimentId], references: [id])
  syncStatus   String   @default("pending") // pending, synced, conflict
  createdAt    DateTime @default(now())
  syncedAt     DateTime?
}

model EquipmentBooking {
  id           String   @id @default(uuid())
  equipmentId  String
  userId       String
  deviceId     String?
  device       MobileDevice? @relation(fields: [deviceId], references: [id])
  startTime    DateTime
  endTime      DateTime
  purpose      String?
  status       String   @default("confirmed") // confirmed, cancelled, completed
  createdAt    DateTime @default(now())
}

enum Role {
  manager
  member
  admin
}

enum Modality {
  fluorescence
  electron_microscopy
  biophysical
  molecular_biology
  biochemistry
  flow_cytometry
  chemistry
  other
}
